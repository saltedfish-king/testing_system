<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD mapper 3.0//EN " "http://mybatis.org/dtd/mybatis-3-mapper.dtd " >
<mapper namespace="com.swpu.dao.ExamDao">

	<!-- 三种题目 -->
	<resultMap type="com.swpu.bean.ChooseTopic" id="chooseTopicMap">
		<id column="id" property="id"/>
		<result column="topicMsg" property="topicMsg"/>
		<result column="topicAnswer" property="topicAnswer"/>
		<result column="chooseA" property="chooseA"/>
		<result column="chooseB" property="chooseB"/>
		<result column="chooseC" property="chooseC"/>
		<result column="chooseD" property="chooseD"/>
		<result column="subjects" property="subjects"/>
		<result column="state" property="state"/>
		<result column="teacherId" property="teacherId"/>
	</resultMap>
	<resultMap type="com.swpu.bean.FullTopic" id="fullTopicMap">
		<id column="id" property="id"/>
		<result column="topicMsg" property="topicMsg"/>
		<result column="topicAnswer" property="topicAnswer"/>
		<result column="state" property="state"/>
		<result column="subjects" property="subjects"/>
		<result column="teacherId" property="teacherId"/>
	</resultMap>
	<resultMap type="com.swpu.bean.LargeTopic" id="largeTopicMap">
		<id column="id" property="id"/>
		<result column="topicMsg" property="topicMsg"/>
		<result column="topicAnswer" property="topicAnswer"/>
		<result column="state" property="state"/>
		<result column="subjects" property="subjects"/>
		<result column="teacherId" property="teacherId"/>
	</resultMap>
	
	<!-- 试卷 -->
	<resultMap type="com.swpu.bean.Exam" id="examMap">
		<id column="id" property="id"/>
		<result column="examSubject" property="examSubject"/>
		<result column="state" property="state"/>
		<result column="examName" property="examName"/>
		<collection property="chooseTopic" resultMap="chooseTopicMap"></collection>
		<collection property="fullTopic" resultMap="fullTopicMap"></collection>
		<collection property="largeTopic" resultMap="largeTopicMap"></collection>
	</resultMap>
	
	<!-- 生成试卷（核心） -->
	<!-- 1、先获取需要的题目 -->
	<select id="selectChoose" parameterType="int" resultMap="chooseTopicMap">
		SELECT * FROM chooseTopic WHERE subjects = #{subjects} ORDER BY RAND() LIMIT 8
	</select>
	<select id="selectFull" parameterType="int" resultMap="fullTopicMap">
		SELECT * FROM fullTopic WHERE subjects = #{subjects} ORDER BY RAND() LIMIT 6
	</select>
	<!-- 2、生成一张试卷 -->
	<insert id="createExam" parameterType="com.swpu.bean.Exam" useGeneratedKeys="true" keyProperty="id">
		INSERT INTO exam (examSubject,state,examName,studentId) VALUES 
		(#{examSubject},#{state},#{examName},#{studentId});
	</insert>
	<!-- 3、将获取的题目加入联系表 -->
	<insert id="EC_Contact" parameterType="java.util.List">
		INSERT INTO exam_chooseTopic (examId,chooseId) VALUES 
		<foreach collection="list" item="item" separator=",">
			(#{item.examId},#{item.id})
		</foreach>
	</insert>
	<insert id="EF_Contact" parameterType="java.util.List">
		INSERT INTO exam_fullTopic (examId,fullId) VALUES 
		<foreach collection="list" item="item" separator=",">
			(#{item.examId},#{item.id})
		</foreach>
	</insert>
</mapper>
